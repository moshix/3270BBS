#!/bin/bash
# copyright 2026 by Moshix. All rights reserved
# 3270BBS  Configuration Generator
# Creates tsu.cnf interactively with validation and error checking
#
# Questions grouped by importance:
#   1. Core Identity & Database
#   2. Security (TLS/SSH)
#   3. User Management & Email
#   4. Web Interface
#   5. Federation & Distributed Features
#   6. Optional Services
#   7. Integrations (Discord)
#   8. Remote Mainframes
#

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color
BOLD='\033[1m'
DIM='\033[2m'

# Helper functions
print_header() {
    clear
    echo -e "${CYAN}╔══════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${WHITE}${BOLD}           3270BBS  Configuration Generator              ${NC}${CYAN}║${NC}"
    echo -e "${CYAN}║${WHITE}              Creates tsu.cnf configuration file                 ${NC}${CYAN}║${NC}"
    echo -e "${CYAN}╚══════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
}

print_section() {
    local num=$1
    local title=$2
    echo ""
    echo -e "${MAGENTA}┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓${NC}"
    echo -e "${MAGENTA}┃ ${WHITE}${BOLD}SECTION $num: $title${NC}"
    echo -e "${MAGENTA}┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛${NC}"
    echo ""
}

print_subsection() {
    echo ""
    echo -e "${YELLOW}  ─── $1 ───${NC}"
    echo ""
}

print_success() {
    echo -e "${GREEN}  ✓ $1${NC}"
}

print_error() {
    echo -e "${RED}  ✗ Error: $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}  ⚠ $1${NC}"
}

print_info() {
    echo -e "${BLUE}  ℹ $1${NC}"
}

print_hint() {
    echo -e "${DIM}    $1${NC}"
}

# Validation functions
validate_port() {
    local port=$1
    if [[ ! $port =~ ^[0-9]+$ ]] || [ "$port" -lt 1 ] || [ "$port" -gt 65535 ]; then
        return 1
    fi
    return 0
}

validate_hostname() {
    local host=$1
    if [[ $host =~ ^localhost$ ]] || \
       [[ $host =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]] || \
       [[ $host =~ ^[a-zA-Z0-9]([a-zA-Z0-9\-]*[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]*[a-zA-Z0-9])?)*$ ]]; then
        return 0
    fi
    return 1
}

validate_yes_no() {
    local answer=$1
    if [[ $answer =~ ^[yYnN]$ ]]; then
        return 0
    fi
    return 1
}

normalize_yes_no() {
    local answer=$1
    case "$answer" in
        [yY]) echo "yes" ;;
        [nN]) echo "no" ;;
        *) echo "no" ;;
    esac
}

validate_bbs_name() {
    local name=$1
    if [ ${#name} -le 10 ] && [[ ! $name =~ \  ]] && [ -n "$name" ]; then
        return 0
    fi
    return 1
}

validate_number() {
    local num=$1
    if [[ $num =~ ^[0-9]+$ ]]; then
        return 0
    fi
    return 1
}

validate_decimal() {
    local num=$1
    if [[ $num =~ ^[0-9]+\.?[0-9]*$ ]]; then
        return 0
    fi
    return 1
}

file_exists() {
    [ -f "$1" ]
}

check_port_available() {
    local port=$1
    if command -v lsof &> /dev/null; then
        if lsof -i :$port &> /dev/null 2>&1; then
            return 1
        fi
    elif command -v netstat &> /dev/null; then
        if netstat -an 2>/dev/null | grep -q ":$port "; then
            return 1
        fi
    fi
    return 0
}

check_port_conflict() {
    local port=$1
    local name=$2
    for used_port in "${used_ports[@]}"; do
        IFS=':' read -r p n <<< "$used_port"
        if [ "$p" = "$port" ]; then
            print_error "Port $port already used by $n"
            return 1
        fi
    done
    used_ports+=("$port:$name")
    return 0
}

ask_question() {
    local prompt=$1
    local default=$2
    local varname=$3
    local value

    if [ -n "$default" ]; then
        echo -en "${WHITE}  $prompt ${CYAN}[$default]${NC}: "
    else
        echo -en "${WHITE}  $prompt${NC}: "
    fi
    read value

    if [ -z "$value" ] && [ -n "$default" ]; then
        value=$default
    fi

    eval "$varname=\"$value\""
}

ask_port() {
    local prompt=$1
    local default=$2
    local varname=$3
    local service_name=$4
    local value

    while true; do
        echo -en "${WHITE}  $prompt ${CYAN}[$default]${NC}: "
        read value

        if [ -z "$value" ]; then
            value=$default
        fi

        if ! validate_port "$value"; then
            print_error "Invalid port number (must be 1-65535)"
            continue
        fi

        if ! check_port_conflict "$value" "$service_name"; then
            continue
        fi

        if ! check_port_available "$value"; then
            print_warning "Port $value appears to be in use on this system"
            echo -en "${WHITE}  Use anyway? ${CYAN}(y/n) [y]${NC}: "
            read use_anyway
            if [[ $use_anyway =~ ^[nN]$ ]]; then
                continue
            fi
        fi

        eval "$varname=$value"
        return 0
    done
}

ask_yes_no() {
    local prompt=$1
    local default=$2
    local varname=$3
    local value

    while true; do
        echo -en "${WHITE}  $prompt ${CYAN}(y/n) [$default]${NC}: "
        read value

        if [ -z "$value" ]; then
            value=$default
        fi

        if validate_yes_no "$value"; then
            eval "$varname=$(normalize_yes_no $value)"
            return 0
        else
            print_error "Please enter 'y' or 'n'"
        fi
    done
}

ask_password() {
    local prompt=$1
    local varname=$2

    echo -en "${WHITE}  $prompt${NC}: "
    read -s value
    echo ""
    eval "$varname=\"$value\""
}

# Track used ports
declare -a used_ports=()

# Store remote mainframes
declare -a remote_numbers=()
declare -A remote_names
declare -A remote_descs
declare -A remote_addrs
declare -A remote_ports
declare -A remote_is_bbs

# ============================================================================
# SECTION 1: CORE IDENTITY & DATABASE
# ============================================================================
configure_core() {
    print_section "1" "CORE IDENTITY & DATABASE"

    print_info "These are the most fundamental settings for your BBS"
    echo ""

    # BBS Name
    print_subsection "BBS Identity"
    print_hint "The BBS name appears in headers and identifies your system"
    while true; do
        ask_question "BBS name (max 10 chars, no spaces)" "Forum3270" bbs_name
        if validate_bbs_name "$bbs_name"; then
            print_success "BBS name: $bbs_name"
            break
        else
            print_error "Name must be 1-10 characters with no spaces"
        fi
    done

    # DNS Name
    echo ""
    print_hint "This is how users will reach your BBS (domain or IP)"
    while true; do
        ask_question "DNS name or IP address" "localhost" dns_name
        if validate_hostname "$dns_name"; then
            print_success "DNS name: $dns_name"
            break
        else
            print_error "Invalid hostname or IP address format"
        fi
    done

    # Main TN3270 port
    echo ""
    print_hint "The main port for 3270 terminal connections"
    ask_port "TN3270 port" "3270" tn3270_port "TN3270"
    print_success "TN3270 port: $tn3270_port"

    # TLS port (asked here, cert/key asked in Security section)
    echo ""
    print_hint "TLS port for encrypted 3270 connections"
    ask_port "TLS port" "2023" tls_port "TLS-3270"
    print_success "TLS port: $tls_port"

    # Ask whether to actually enable TLS
    ask_yes_no "Enable TLS server on startup" "y" start_tls
    if [ "$start_tls" = "yes" ]; then
        print_success "TLS will be enabled"
    else
        print_info "TLS configured but will NOT start automatically"
    fi

    # Database Selection
    print_subsection "Database Selection"
    print_info "SQLite3 is simpler, PostgreSQL enables federation features"
    echo ""
    echo -e "${WHITE}  Choose your database:${NC}"
    echo -e "    ${GREEN}1)${NC} SQLite3 ${DIM}(recommended for single-server setups)${NC}"
    echo -e "    ${GREEN}2)${NC} PostgreSQL ${DIM}(required for federation/global chat)${NC}"
    echo ""

    while true; do
        echo -en "${WHITE}  Enter choice ${CYAN}[1]${NC}: "
        read db_choice

        if [ -z "$db_choice" ]; then
            db_choice=1
        fi

        case $db_choice in
            1)
                db_type="sqlite3"
                print_success "Database: SQLite3"
                break
                ;;
            2)
                db_type="pg"
                print_success "Database: PostgreSQL"
                echo ""
                print_info "PostgreSQL connection details:"

                while true; do
                    ask_question "Database host" "localhost" db_host
                    if validate_hostname "$db_host"; then
                        break
                    else
                        print_error "Invalid hostname"
                    fi
                done

                while true; do
                    ask_question "Database port" "5432" db_port
                    if validate_port "$db_port"; then
                        break
                    else
                        print_error "Invalid port"
                    fi
                done

                ask_question "Database name" "tsu3270" db_name
                ask_question "Database user" "tsu" db_user
                ask_password "Database password" db_password

                if [ -z "$db_password" ]; then
                    print_warning "Empty password - ensure this is intentional"
                else
                    print_success "PostgreSQL credentials configured"
                fi
                break
                ;;
            *)
                print_error "Please enter 1 or 2"
                ;;
        esac
    done
}

# ============================================================================
# SECTION 2: SECURITY (TLS & SSH)
# ============================================================================
configure_security() {
    print_section "2" "SECURITY"

    print_info "Secure your BBS with TLS encryption and SSH access"

    # TLS Certificate/Key Configuration (port was already set in Section 1)
    print_subsection "TLS/SSL Certificate"

    if [ "$start_tls" = "yes" ]; then
        print_info "TLS enabled on port $tls_port (configured in Section 1)"
        echo ""
        print_hint "You need a certificate and private key file for TLS"

        while true; do
            ask_question "Path to TLS certificate (.crt/.pem)" "" tls_cert
            if [ -z "$tls_cert" ]; then
                print_error "Certificate path required for TLS"
                continue
            fi
            if file_exists "$tls_cert"; then
                print_success "Certificate found: $tls_cert"
                break
            else
                print_warning "File not found: $tls_cert"
                ask_yes_no "Continue anyway (add file later)" "n" cert_continue
                if [ "$cert_continue" = "yes" ]; then
                    break
                fi
            fi
        done

        while true; do
            ask_question "Path to TLS private key (.key)" "" tls_key
            if [ -z "$tls_key" ]; then
                print_error "Key path required for TLS"
                continue
            fi
            if file_exists "$tls_key"; then
                print_success "Key found: $tls_key"
                break
            else
                print_warning "File not found: $tls_key"
                ask_yes_no "Continue anyway (add file later)" "n" key_continue
                if [ "$key_continue" = "yes" ]; then
                    break
                fi
            fi
        done

        print_success "TLS encryption configured"
    else
        print_info "TLS disabled (no port configured in Section 1)"
        print_hint "To enable TLS, re-run configure and enter a TLS port"
    fi

    # SSH Configuration
    print_subsection "SSH Server"
    print_hint "SSH provides an alternative secure terminal access method"

    ask_yes_no "Enable SSH server" "y" start_sshd

    if [ "$start_sshd" = "yes" ]; then
        ask_port "SSH port" "3296" ssh_port "SSH"
        print_success "SSH server enabled on port $ssh_port"
    else
        print_info "SSH server disabled"
    fi
}

# ============================================================================
# SECTION 3: USER MANAGEMENT & EMAIL
# ============================================================================
configure_users() {
    print_section "3" "USER MANAGEMENT & EMAIL"

    print_info "Configure how users register and receive notifications"

    # Email verification
    print_subsection "New User Registration"

    ask_yes_no "Require email verification for new users" "y" verify_email
    if [ "$verify_email" = "yes" ]; then
        print_success "Email verification enabled"
    else
        print_warning "Users can register without email verification"
    fi

    ask_yes_no "Notify admin when new users register" "y" notify_admin

    # SendGrid
    print_subsection "Email Service (SendGrid)"
    print_hint "SendGrid is used to send verification and notification emails"
    print_hint "Get an API key at https://sendgrid.com"
    echo ""

    ask_question "SendGrid API key (leave empty to disable email)" "" sendgrid_key

    if [ -n "$sendgrid_key" ]; then
        print_success "SendGrid configured"

        while true; do
            ask_question "Maximum emails per user per day" "5" max_emails
            if validate_number "$max_emails"; then
                break
            else
                print_error "Must be a number"
            fi
        done
    else
        print_warning "No SendGrid key - email features disabled"
        max_emails="5"
        if [ "$verify_email" = "yes" ]; then
            print_warning "Email verification requires SendGrid - will be non-functional"
        fi
    fi

    # Required conferences
    print_subsection "Conference Settings"
    print_hint "These conferences cannot be unsubscribed by users"
    print_hint "Format: comma-separated, each in quotes"

    ask_question "Required conferences" '"General","3270BBS","User content"' required_conferences
}

# ============================================================================
# SECTION 4: WEB INTERFACE
# ============================================================================
configure_web() {
    print_section "4" "WEB INTERFACE"

    print_info "The web interface allows browser-based access to the BBS"

    ask_yes_no "Enable web interface" "y" start_httpd

    if [ "$start_httpd" = "yes" ]; then
        ask_port "HTTP port" "9000" http_port "HTTP"
        print_success "HTTP enabled on port $http_port"

        if [ "$start_tls" = "yes" ]; then
            echo ""
            print_hint "HTTPS uses the same certificate as TLS"
            ask_yes_no "Enable HTTPS" "y" enable_https
            if [ "$enable_https" = "yes" ]; then
                ask_port "HTTPS port" "9443" https_port "HTTPS"
                print_success "HTTPS enabled on port $https_port"
            fi
        else
            print_info "HTTPS requires TLS to be enabled"
            enable_https="no"
        fi

        print_success "Web interface configured"
    else
        print_info "Web interface disabled"
    fi

    # MOTD
    print_subsection "Message of the Day"
    print_hint "Displayed to users on login"

    default_motd="Welcome to $bbs_name!"
    if [ "$start_sshd" = "yes" ]; then
        default_motd="SSH: ssh -p $ssh_port user@$dns_name"
    fi
    ask_question "MOTD message" "$default_motd" motd
}

# ============================================================================
# SECTION 5: FEDERATION & DISTRIBUTED FEATURES
# ============================================================================
configure_federation() {
    print_section "5" "FEDERATION & DISTRIBUTED FEATURES"

    print_info "Federation connects multiple TSU instances for shared chat/newsgroups"
    echo ""

    if [ "$db_type" != "pg" ]; then
        print_warning "Federation features work best with PostgreSQL"
        print_hint "You selected SQLite3 - federation will have limitations"
        echo ""
    fi

    ask_yes_no "Join a federation network" "n" join_federation

    if [ "$join_federation" = "yes" ]; then
        # Global Chat
        print_subsection "Global Chat Database"
        print_hint "Connect to the federation's shared chat database"

        while true; do
            ask_question "Global chat server address" "" globalchat_addr
            if [ -z "$globalchat_addr" ]; then
                print_error "Server address required"
                continue
            fi
            if validate_hostname "$globalchat_addr"; then
                break
            else
                print_error "Invalid hostname"
            fi
        done

        while true; do
            ask_question "Global chat server port" "5432" globalchat_port
            if validate_port "$globalchat_port"; then
                break
            else
                print_error "Invalid port"
            fi
        done

        ask_question "Global chat DB user" "" globalchat_user
        ask_password "Global chat DB password" globalchat_password

        # Poll rate
        echo ""
        print_hint "Poll rate: how many times per second to check for new messages"
        print_hint "Higher = more responsive but more load (0.5 to 2 recommended)"
        while true; do
            ask_question "Global chat poll rate (per second)" "1" globalchat_pollrate
            if validate_decimal "$globalchat_pollrate"; then
                break
            else
                print_error "Must be a number (e.g., 0.5, 1, 2)"
            fi
        done

        print_success "Global chat configured"

        # Newsgroups
        print_subsection "Newsgroups Database"

        ask_yes_no "Use same server for newsgroups" "y" same_newsgroup

        if [ "$same_newsgroup" = "yes" ]; then
            newsgroup_addr=$globalchat_addr
            newsgroup_port=$globalchat_port
            newsgroup_user=$globalchat_user
            newsgroup_password=$globalchat_password
            print_success "Using same server for newsgroups"
        else
            while true; do
                ask_question "Newsgroup server address" "" newsgroup_addr
                if validate_hostname "$newsgroup_addr"; then
                    break
                fi
            done

            while true; do
                ask_question "Newsgroup server port" "5432" newsgroup_port
                if validate_port "$newsgroup_port"; then
                    break
                fi
            done

            ask_question "Newsgroup DB user" "" newsgroup_user
            ask_password "Newsgroup DB password" newsgroup_password
        fi

        ask_question "Newsgroup database name" "newsgroups" newsgroup_db_name

        # BBS-to-BBS Mail
        print_subsection "BBS-to-BBS Mail"
        print_hint "Port for receiving mail from other 3270BBS instances"

        ask_yes_no "Enable BBS-to-BBS mail" "y" enable_bbs_mail
        if [ "$enable_bbs_mail" = "yes" ]; then
            ask_port "Mail listen port" "8000" mail_listen_port "BBS-Mail"
            print_success "BBS-to-BBS mail enabled on port $mail_listen_port"
        fi

        print_success "Federation fully configured"

    else
        print_info "Running as standalone instance (no federation)"
    fi
}

# ============================================================================
# SECTION 6: OPTIONAL SERVICES
# ============================================================================
configure_services() {
    print_section "6" "OPTIONAL SERVICES"

    print_info "Additional services to enhance your BBS"

    # Proxy3270
    print_subsection "Proxy3270 Gateway"
    print_hint "Allows users to connect to remote mainframes through your BBS"

    ask_yes_no "Enable Proxy3270" "y" start_proxy
    if [ "$start_proxy" = "yes" ]; then
        print_success "Proxy3270 enabled"
    fi

    # FTP Server
    print_subsection "FTP Server"
    print_hint "Allows file uploads for user notes/files"

    ask_yes_no "Enable FTP server" "n" start_ftpd

    if [ "$start_ftpd" = "yes" ]; then
        ask_port "FTP port" "2100" ftp_port "FTP"

        while true; do
            ask_question "Upload size limit (KB)" "40" ftp_limit
            if validate_number "$ftp_limit"; then
                break
            else
                print_error "Must be a number"
            fi
        done

        print_success "FTP server enabled on port $ftp_port (limit: ${ftp_limit}KB)"
    fi

    # Finger Daemon
    print_subsection "Finger Daemon"
    print_hint "Classic protocol for user lookup (finger user@host)"

    ask_yes_no "Enable finger daemon" "y" start_fingerd

    if [ "$start_fingerd" = "yes" ]; then
        ask_port "Finger port" "1079" finger_port "Finger"
        print_success "Finger daemon enabled on port $finger_port"
    fi

    # SMTP Server
    print_subsection "SMTP Server"
    print_hint "Receive emails directly (for BBS mail integration)"

    ask_yes_no "Enable SMTP server" "n" start_smtpd

    if [ "$start_smtpd" = "yes" ]; then
        ask_port "SMTP port" "25" smtp_port "SMTP"
        ask_question "SMTP domain" "$dns_name" smtp_domain
        ask_yes_no "Drop DMARC-failing emails" "y" smtp_drop_dmarc
        print_success "SMTP server enabled on port $smtp_port"
    fi
}

# ============================================================================
# SECTION 7: INTEGRATIONS
# ============================================================================
configure_integrations() {
    print_section "7" "INTEGRATIONS"

    print_info "Connect your BBS to external services"

    # Discord
    print_subsection "Discord Integration"
    print_hint "Bridge BBS chat with a Discord server"

    ask_yes_no "Enable Discord integration" "n" enable_discord

    if [ "$enable_discord" = "yes" ]; then
        echo ""
        print_hint "Create a bot at https://discord.com/developers/applications"

        ask_question "Discord bot token" "" discord_token

        if [ -z "$discord_token" ]; then
            print_warning "No token provided - Discord will be disabled"
            enable_discord="no"
        else
            ask_question "Discord guild (server) ID" "" discord_guild
            ask_yes_no "Show Discord option in menu" "y" show_discord_menu
            print_success "Discord integration configured"
        fi
    else
        print_info "Discord integration disabled"
    fi

    # News API
    print_subsection "News API (optional)"
    print_hint "Used for market news in the stock quote terminal"
    print_hint "Get a free key at https://newsapi.org"
    ask_question "News API key (leave empty to skip)" "" news_api_key
    if [ -n "$news_api_key" ]; then
        print_success "News API configured"
    fi
}

# ============================================================================
# SECTION 8: REMOTE MAINFRAMES
# ============================================================================
configure_remotes() {
    print_section "8" "REMOTE MAINFRAME CONNECTIONS"

    print_info "Configure mainframes users can connect to via Proxy3270"

    if [ "$start_proxy" != "yes" ]; then
        print_warning "Proxy3270 is disabled - remote connections won't be available"
        ask_yes_no "Configure remote mainframes anyway" "n" config_remotes_anyway
        if [ "$config_remotes_anyway" != "yes" ]; then
            remote_count=0
            return
        fi
    fi

    echo ""
    print_hint "You can configure up to 15 remote mainframes"
    print_hint "Remote numbers can be 1-15 (gaps are allowed)"
    print_hint "Enter 'done' or press Enter on number to finish"
    echo ""

    remote_count=0

    while true; do
        echo -en "${WHITE}  Remote number (1-15) or 'done' to finish${NC}: "
        read remote_num

        # Check for done
        if [ -z "$remote_num" ] || [ "$remote_num" = "done" ]; then
            break
        fi

        # Validate number
        if ! validate_number "$remote_num" || [ "$remote_num" -lt 1 ] || [ "$remote_num" -gt 15 ]; then
            print_error "Please enter a number between 1 and 15"
            continue
        fi

        # Check if already used
        if [[ " ${remote_numbers[*]} " =~ " ${remote_num} " ]]; then
            print_error "Remote $remote_num already configured"
            continue
        fi

        echo ""
        ask_question "  Name (short identifier)" "" tmp_name
        if [ -z "$tmp_name" ]; then
            print_error "Name is required"
            continue
        fi

        ask_question "  Description" "" tmp_desc

        while true; do
            ask_question "  Host address" "" tmp_addr
            if [ -z "$tmp_addr" ]; then
                print_error "Address required"
                continue
            fi
            if validate_hostname "$tmp_addr"; then
                break
            else
                print_error "Invalid hostname"
            fi
        done

        while true; do
            ask_question "  Port" "3270" tmp_port
            if validate_port "$tmp_port"; then
                break
            else
                print_error "Invalid port"
            fi
        done

        ask_yes_no "  Is this another 3270BBS instance" "n" tmp_is_bbs

        # Store the remote
        remote_numbers+=($remote_num)
        remote_names[$remote_num]="$tmp_name"
        remote_descs[$remote_num]="$tmp_desc"
        remote_addrs[$remote_num]="$tmp_addr"
        remote_ports[$remote_num]="$tmp_port"
        remote_is_bbs[$remote_num]="$tmp_is_bbs"

        remote_count=$((remote_count + 1))
        print_success "Remote #$remote_num ($tmp_name) configured"
        echo ""
    done

    if [ $remote_count -eq 0 ]; then
        print_info "No remote mainframes configured"
    else
        print_success "Configured $remote_count remote mainframe(s)"
    fi
}

# ============================================================================
# SUMMARY & GENERATION
# ============================================================================
show_summary() {
    echo ""
    echo -e "${CYAN}╔══════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${WHITE}${BOLD}                    CONFIGURATION SUMMARY                        ${NC}${CYAN}║${NC}"
    echo -e "${CYAN}╚══════════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    # Core
    echo -e "${WHITE}${BOLD}CORE:${NC}"
    echo -e "  BBS Name:      ${GREEN}$bbs_name${NC}"
    echo -e "  DNS/Host:      ${GREEN}$dns_name${NC}"
    echo -e "  TN3270 Port:   ${GREEN}$tn3270_port${NC}"
    if [ "$db_type" = "pg" ]; then
        echo -e "  Database:      ${GREEN}PostgreSQL${NC} ($db_host:$db_port/$db_name)"
    else
        echo -e "  Database:      ${GREEN}SQLite3${NC}"
    fi
    echo ""

    # Security
    echo -e "${WHITE}${BOLD}SECURITY:${NC}"
    if [ "$start_tls" = "yes" ]; then
        echo -e "  TLS:           ${GREEN}✓ Enabled${NC} (port $tls_port)"
        echo -e "  Certificate:   ${DIM}$tls_cert${NC}"
    else
        echo -e "  TLS:           ${YELLOW}✗ Disabled${NC}"
    fi
    if [ "$start_sshd" = "yes" ]; then
        echo -e "  SSH:           ${GREEN}✓ Enabled${NC} (port $ssh_port)"
    else
        echo -e "  SSH:           ${YELLOW}✗ Disabled${NC}"
    fi
    echo ""

    # Services
    echo -e "${WHITE}${BOLD}SERVICES:${NC}"
    if [ "$start_httpd" = "yes" ]; then
        if [ "$enable_https" = "yes" ]; then
            echo -e "  Web Interface: ${GREEN}✓${NC} HTTP:$http_port, HTTPS:$https_port"
        else
            echo -e "  Web Interface: ${GREEN}✓${NC} HTTP:$http_port"
        fi
    fi
    [ "$start_proxy" = "yes" ] && echo -e "  Proxy3270:     ${GREEN}✓${NC}"
    [ "$start_ftpd" = "yes" ] && echo -e "  FTP Server:    ${GREEN}✓${NC} (port $ftp_port, limit ${ftp_limit}KB)"
    [ "$start_fingerd" = "yes" ] && echo -e "  Finger:        ${GREEN}✓${NC} (port $finger_port)"
    [ "$start_smtpd" = "yes" ] && echo -e "  SMTP:          ${GREEN}✓${NC} (port $smtp_port, domain: $smtp_domain)"
    echo ""

    # Federation
    echo -e "${WHITE}${BOLD}FEDERATION:${NC}"
    if [ "$join_federation" = "yes" ]; then
        echo -e "  Global Chat:   ${GREEN}✓${NC} $globalchat_addr:$globalchat_port (poll: ${globalchat_pollrate}/s)"
        echo -e "  Newsgroups:    ${GREEN}✓${NC} $newsgroup_addr:$newsgroup_port/$newsgroup_db_name"
        [ "$enable_bbs_mail" = "yes" ] && echo -e "  BBS-to-BBS:    ${GREEN}✓${NC} (port $mail_listen_port)"
    else
        echo -e "  Status:        ${DIM}Standalone (no federation)${NC}"
    fi
    echo ""

    # Email & Integrations
    echo -e "${WHITE}${BOLD}EMAIL & INTEGRATIONS:${NC}"
    if [ -n "$sendgrid_key" ]; then
        echo -e "  SendGrid:      ${GREEN}✓${NC} (max $max_emails emails/day)"
    else
        echo -e "  SendGrid:      ${YELLOW}✗ Not configured${NC}"
    fi
    echo -e "  Email verify:  $([ "$verify_email" = "yes" ] && echo "${GREEN}✓${NC}" || echo "${YELLOW}✗${NC}")"
    echo -e "  Admin notify:  $([ "$notify_admin" = "yes" ] && echo "${GREEN}✓${NC}" || echo "${YELLOW}✗${NC}")"
    [ "$enable_discord" = "yes" ] && echo -e "  Discord:       ${GREEN}✓${NC} (guild: $discord_guild)"
    echo ""

    # Remote mainframes
    if [ $remote_count -gt 0 ]; then
        echo -e "${WHITE}${BOLD}REMOTE MAINFRAMES:${NC} ($remote_count configured)"
        for num in "${remote_numbers[@]}"; do
            local bbs_flag=""
            [ "${remote_is_bbs[$num]}" = "yes" ] && bbs_flag=" ${CYAN}[3270BBS]${NC}"
            echo -e "  ${GREEN}#$num${NC} ${remote_names[$num]} - ${remote_addrs[$num]}:${remote_ports[$num]}$bbs_flag"
        done
        echo ""
    fi
}

generate_config() {
    output_file="tsu.cnf"

    # Backup existing
    if file_exists "$output_file"; then
        print_warning "Existing $output_file found"
        ask_yes_no "Create backup before overwriting" "y" backup_file
        if [ "$backup_file" = "yes" ]; then
            backup_name="tsu.cnf.backup.$(date +%Y%m%d_%H%M%S)"
            cp "$output_file" "$backup_name"
            print_success "Backed up to: $backup_name"
        fi
    fi

    # Generate the file
    cat > "$output_file" << ENDCONFIG
# TSU Configuration File
# Generated by ./configure on $(date)
# ============================================================================

# ============================================================================
# DATABASE SETTINGS
# ============================================================================
ENDCONFIG

    if [ "$db_type" = "pg" ]; then
        cat >> "$output_file" << ENDCONFIG
db=pg
db_user=$db_user
db_password=$db_password
db_name=$db_name
db_host=$db_host
db_port=$db_port
ENDCONFIG
    else
        cat >> "$output_file" << ENDCONFIG
db=sqlite3
#db_user=
#db_password=
#db_name=
#db_host=
#db_port=
ENDCONFIG
    fi

    cat >> "$output_file" << ENDCONFIG

# ============================================================================
# GENERAL SETTINGS
# ============================================================================
bbs_name=$bbs_name
dns_name=$dns_name
port=$tn3270_port
ENDCONFIG

    if [ "$start_tls" = "yes" ]; then
        cat >> "$output_file" << ENDCONFIG
tlsport=$tls_port
tlscert=$tls_cert
tlskey=$tls_key
start_TLS=yes
ENDCONFIG
    else
        echo "start_TLS=no" >> "$output_file"
    fi

    cat >> "$output_file" << ENDCONFIG

# verify email address of new accounts?
verify_newuser_email=$verify_email

ENDCONFIG

    # SendGrid
    cat >> "$output_file" << ENDCONFIG
# ============================================================================
# SENDGRID API KEY
# ============================================================================
ENDCONFIG
    if [ -n "$sendgrid_key" ]; then
        echo "SENDGRID_API_KEY=\"$sendgrid_key\"" >> "$output_file"
    else
        echo "#SENDGRID_API_KEY=\"\"" >> "$output_file"
    fi
    echo "max_emails_per_day=$max_emails" >> "$output_file"

    # Finger
    cat >> "$output_file" << ENDCONFIG

# ============================================================================
# FINGER DAEMON
# ============================================================================
ENDCONFIG
    if [ "$start_fingerd" = "yes" ]; then
        cat >> "$output_file" << ENDCONFIG
fingerd_port=$finger_port
start_fingerd=yes
ENDCONFIG
    else
        echo "start_fingerd=no" >> "$output_file"
    fi

    # Admin notifications
    cat >> "$output_file" << ENDCONFIG

# notify admin user of new accounts?
notify_admin_new_accounts=$notify_admin

# these conferences cannot be unsubscribed
required_conferences=$required_conferences

ENDCONFIG

    # Federation - Global Chat
    cat >> "$output_file" << ENDCONFIG
# ============================================================================
# GLOBAL CHAT SETTINGS
# ============================================================================
ENDCONFIG
    if [ "$join_federation" = "yes" ]; then
        cat >> "$output_file" << ENDCONFIG
globalchat_db_address=$globalchat_addr
globalchat_db_port=$globalchat_port
globalchat_db_user=$globalchat_user
globalchat_db_password=$globalchat_password
# pollrate is how often per second it will poll
globalchat_pollrate=$globalchat_pollrate
ENDCONFIG
    else
        cat >> "$output_file" << ENDCONFIG
#globalchat_db_address=
#globalchat_db_port=
#globalchat_db_user=
#globalchat_db_password=
#globalchat_pollrate=1
ENDCONFIG
    fi

    # Newsgroups
    cat >> "$output_file" << ENDCONFIG

# ============================================================================
# NEWSGROUPS SETTINGS
# ============================================================================
ENDCONFIG
    if [ "$join_federation" = "yes" ]; then
        cat >> "$output_file" << ENDCONFIG
newsgroup_db_address=$newsgroup_addr
newsgroup_db_port=$newsgroup_port
newsgroup_db_user=$newsgroup_user
newsgroup_db_password=$newsgroup_password
newsgroup_db_name=$newsgroup_db_name
ENDCONFIG
    else
        cat >> "$output_file" << ENDCONFIG
#newsgroup_db_address=
#newsgroup_db_port=
#newsgroup_db_user=
#newsgroup_db_password=
#newsgroup_db_name=
ENDCONFIG
    fi

    # SMTP
    cat >> "$output_file" << ENDCONFIG

# ============================================================================
# SMTP SERVER
# ============================================================================
ENDCONFIG
    if [ "$start_smtpd" = "yes" ]; then
        cat >> "$output_file" << ENDCONFIG
start_SMTPD=yes
smtp_port=$smtp_port
smtp_domain=$smtp_domain
smtp_drop_dimarc=$smtp_drop_dmarc
ENDCONFIG
    else
        cat >> "$output_file" << ENDCONFIG
start_SMTPD=no
#smtp_port=25
#smtp_domain=
#smtp_drop_dimarc=yes
ENDCONFIG
    fi

    # Web interface
    cat >> "$output_file" << ENDCONFIG

# ============================================================================
# WEB INTERFACE
# ============================================================================
ENDCONFIG
    if [ "$start_httpd" = "yes" ]; then
        cat >> "$output_file" << ENDCONFIG
httpd_port=$http_port
ENDCONFIG
        if [ "$enable_https" = "yes" ]; then
            echo "https_port=$https_port" >> "$output_file"
        fi
        echo "start_HTTPD=yes" >> "$output_file"
    else
        cat >> "$output_file" << ENDCONFIG
httpd_port=9000
https_port=9443
start_HTTPD=no
ENDCONFIG
    fi

    cat >> "$output_file" << ENDCONFIG

MOTD="$motd"

# ============================================================================
# FTP SERVER
# ============================================================================
# FTP upload limit in KB
FTP_limit=${ftp_limit:-40}
FTP_port=${ftp_port:-2100}
ENDCONFIG
    if [ "$start_ftpd" = "yes" ]; then
        echo "start_FTPD=yes" >> "$output_file"
    else
        echo "start_FTPD=no" >> "$output_file"
    fi

    # Proxy
    cat >> "$output_file" << ENDCONFIG
start_proxy3270=$start_proxy

# ============================================================================
# SSH SERVER SETTINGS
# ============================================================================
ENDCONFIG
    if [ "$start_sshd" = "yes" ]; then
        cat >> "$output_file" << ENDCONFIG
start_SSHD=yes
sshd_port=$ssh_port
ENDCONFIG
    else
        cat >> "$output_file" << ENDCONFIG
start_SSHD=no
#sshd_port=3296
ENDCONFIG
    fi

    # Discord
    cat >> "$output_file" << ENDCONFIG

# ============================================================================
# DISCORD ACCESS
# ============================================================================
ENDCONFIG
    if [ "$enable_discord" = "yes" ]; then
        cat >> "$output_file" << ENDCONFIG
discord_token=$discord_token
discord_guild_id=$discord_guild
show_discord_in_menu=$show_discord_menu
ENDCONFIG
    else
        cat >> "$output_file" << ENDCONFIG
#discord_token=
#discord_guild_id=
show_discord_in_menu=no
ENDCONFIG
    fi

    # News API key
    if [ -n "$news_api_key" ]; then
        cat >> "$output_file" << ENDCONFIG

# ============================================================================
# NEWS API
# ============================================================================
newsapikey=$news_api_key
ENDCONFIG
    fi

    # BBS-to-BBS mail (if federation enabled)
    if [ "$join_federation" = "yes" ] && [ "$enable_bbs_mail" = "yes" ]; then
        cat >> "$output_file" << ENDCONFIG

# ============================================================================
# BBS-TO-BBS MAIL SETTINGS
# ============================================================================
mail_listen_port=$mail_listen_port
ENDCONFIG
    fi

    # Remote mainframes
    if [ $remote_count -gt 0 ]; then
        cat >> "$output_file" << ENDCONFIG

# ============================================================================
# REMOTE MAINFRAME SETTINGS
# ============================================================================
ENDCONFIG
        # Sort the remote numbers
        IFS=$'\n' sorted_nums=($(sort -n <<<"${remote_numbers[*]}")); unset IFS

        for num in "${sorted_nums[@]}"; do
            cat >> "$output_file" << ENDCONFIG
remote$num=${remote_names[$num]}
remote${num}_description="${remote_descs[$num]}"
remote${num}_addr=${remote_addrs[$num]}
remote${num}_port=${remote_ports[$num]}
ENDCONFIG
            if [ "${remote_is_bbs[$num]}" = "yes" ]; then
                echo "remote${num}_is_3270BBS=yes" >> "$output_file"
            fi
            echo "" >> "$output_file"
        done
    fi

    print_success "Configuration written to: $output_file"
}

# ============================================================================
# MAIN
# ============================================================================
main() {
    if [ ! -t 0 ]; then
        echo -e "${RED}Error: This script must be run interactively${NC}"
        exit 1
    fi

    print_header

    echo -e "${WHITE}This script will guide you through configuring TSU.${NC}"
    echo -e "${WHITE}Configuration is organized by importance:${NC}"
    echo ""
    echo -e "  ${CYAN}1.${NC} Core Identity & Database ${DIM}(essential)${NC}"
    echo -e "  ${CYAN}2.${NC} Security ${DIM}(TLS & SSH)${NC}"
    echo -e "  ${CYAN}3.${NC} User Management & Email"
    echo -e "  ${CYAN}4.${NC} Web Interface"
    echo -e "  ${CYAN}5.${NC} Federation ${DIM}(multi-BBS networks)${NC}"
    echo -e "  ${CYAN}6.${NC} Optional Services ${DIM}(FTP, Finger, SMTP)${NC}"
    echo -e "  ${CYAN}7.${NC} Integrations ${DIM}(Discord)${NC}"
    echo -e "  ${CYAN}8.${NC} Remote Mainframes"
    echo ""
    echo -e "${DIM}Press Enter to accept defaults shown in [brackets]${NC}"
    echo ""

    ask_yes_no "Begin configuration" "y" begin_config

    if [ "$begin_config" != "yes" ]; then
        echo ""
        print_info "Configuration cancelled"
        exit 0
    fi

    # Run configuration sections in order of importance
    configure_core
    configure_security
    configure_users
    configure_web
    configure_federation
    configure_services
    configure_integrations
    configure_remotes

    # Summary and generate
    show_summary

    echo ""
    ask_yes_no "Generate tsu.cnf with these settings" "y" do_generate

    if [ "$do_generate" = "yes" ]; then
        echo ""
        generate_config

        echo ""
        echo -e "${GREEN}╔══════════════════════════════════════════════════════════════════╗${NC}"
        echo -e "${GREEN}║${WHITE}${BOLD}                 Configuration Complete!                         ${NC}${GREEN}║${NC}"
        echo -e "${GREEN}╚══════════════════════════════════════════════════════════════════╝${NC}"
        echo ""
        echo -e "${WHITE}Next steps:${NC}"
        echo -e "  ${CYAN}1.${NC} Review tsu.cnf for any final adjustments"
        if [ "$db_type" = "sqlite3" ]; then
            echo -e "  ${CYAN}2.${NC} Run ${GREEN}./create_tsudb.bash${NC} to create the database"
        else
            echo -e "  ${CYAN}2.${NC} Run ${GREEN}./create_postgres_db.bash${NC} to create the database"
        fi
        echo -e "  ${CYAN}3.${NC} Build and run: ${GREEN}go build -o 3270BBS && ./3270BBS${NC}"
        echo ""
        print_warning "SECURITY: Change default passwords after first login!"
        echo -e "          ${DIM}Default accounts: admin/admin, noreply/noreply${NC}"
        echo ""
    else
        print_info "Configuration not saved"
    fi
}

main "$@"
